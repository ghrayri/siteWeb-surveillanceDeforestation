---
config:
  look: neo
  theme: neo
---
sequenceDiagram
    actor Utilisateur as Utilisateur
    participant Frontend as Frontend (React)
    participant AuthService as AuthService (Django)
    participant PermissionService as PermissionService (Django)
    participant GeoApp as GeoApp (Django)
    participant GeoAsync as Tâches Asynchrones (Celery)
    participant Zone as Zone
    participant Donnee as Donnée
    participant EO as Données EO
    participant IoT as Données IoT
    participant Realtime as TempsRéel
    participant Analyse as Analyse
    participant Export as Export
    participant Log as Log
    participant PostGIS as PostGIS
    participant Leaflet as Leaflet
    Utilisateur->>Frontend: Accès à l'interface
    Frontend->>AuthService: login(email, password)
    AuthService-->>Frontend: JWT (token)
    Frontend->>PermissionService: checkPermission(EXPORT_DATA)
    PermissionService->>AuthService: verifyToken(token)
    AuthService-->>PermissionService: valid
    PermissionService->>PermissionService: vérifie rôle/permissions
    alt permission accordée
        PermissionService-->>Frontend: true
        Frontend->>Leaflet: Affiche carte interactive
        Utilisateur->>Frontend: Sélectionne zone/couche/temps
        Frontend->>GeoApp: getZoneData(zone)
        GeoApp->>PostGIS: Query spatiale
        PostGIS-->>GeoApp: Données géospatiales
        GeoApp-->>Frontend: Données zone
        Frontend->>Leaflet: Affiche données
        Frontend->>GeoApp: getEOData(zone, période)
        GeoApp->>EO: Récupère images satellites
        EO-->>GeoApp: Images/indices
        GeoApp-->>Frontend: Données EO
        Frontend->>GeoApp: getIoTData(zone)
        GeoApp->>IoT: Récupère capteurs
        IoT-->>GeoApp: Données capteurs
        GeoApp-->>Frontend: Données IoT
        Frontend->>GeoApp: getRealtimeData(zone)
        GeoApp->>Realtime: Flux temps réel
        Realtime-->>GeoApp: Données live
        GeoApp-->>Frontend: Données temps réel
        Frontend->>GeoApp: analyse(zone, type)
        GeoApp->>Analyse: Lance analyse
        Analyse-->>GeoApp: Résultats
        GeoApp-->>Frontend: Résultats analyse
        Frontend->>GeoAsync: créerTache(EXPORT, zone, format)
        GeoAsync->>Export: générerFichier(format)
        Export->>GeoApp: exporterDonnees()
        GeoApp->>PostGIS: Export données
        PostGIS-->>GeoApp: Données formatées
        GeoApp-->>Export: données formatées
        Export-->>GeoAsync: fichier prêt (filePath)
        GeoAsync-->>Frontend: confirmation export
        Frontend-->>Utilisateur: Notification export
        PermissionService->>Log: logAction(EXPORT, Utilisateur, Zone)
    else permission refusée
        PermissionService-->>Frontend: false (erreur)
        Frontend-->>Utilisateur: Message erreur
        PermissionService->>Log: logAction(TENTATIVE_ACCES_NON_AUTORISE)
    end
